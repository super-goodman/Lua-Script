pickUpState = 0

function drink() --吃喝
    local drinkBag, drinkSlot = getBelongBagAndSlotByID(30703)
    local breadBag, breadSlot = getBelongBagAndSlotByID(22895)
    if drinkSlot == 0 or breadSlot == 0 then
        standBy()
        castSpellA("造食术(等级 7)")
        sleep(3500)
        castSpellA("造水术(等级 8)")
        sleep(3500)
    end
    local je1Bag, je1Slot = getBelongBagAndSlotByID(22044)
    if je1Slot == 0 then
        standBy()
        castSpellA("制造魔法玉石")
        sleep(3500)
    end
    if getRoleCurrentHP() < 95 and getRoleCurrentMP() < 95 and getRoleCurrentHP() >= 0 and getRoleCurrentMP() >= 0 then
        useItem("魔法肉桂面包")
        useItem("魔法山泉水")
    end
    while true do
        if getRoleCurrentHP() == -1 then
            break
        end
        if IsBuffExist(29073) == 0 or IsBuffExist(34291) == 0 then
            useItem("魔法肉桂面包")
            useItem("魔法山泉水")
        end
        if getRoleCurrentHP() >= 95 and getRoleCurrentMP() >= 95 then
            break
        end
        sleep(1000)
    end
    
end


function battle()
    local ID1,ID2 = getClosetTargetIDInBattle(3)
    local name,chat = getChatInfoByType(7)
    if name ~= "" and name ~= 0 and name ~= -1 then
        --useLua("/reply 没有")
    end
    while ID1 ~= 0 and ID1 ~= -1 do
        ID1,ID2 = getClosetTargetIDInBattle(3)
        local distance = getTargetAndRoleDistanceByID(ID1,ID2,3)
        if distance <= 10 and distance >= 0 then
            castSpellB("魔爆术(等级 8)")
        end
    end
end


function pickUp(x,y) --拾取
    if pickUpState == 0 then
        return 0
    end
    local distance = 0
    local x1,y1,z1,ID1,ID2 = 0,0,0,0,0
    while true do -- 循环n次（mld可能有很多怪）
        sleep(10)
        if getRoleCurrentHP() == -1 then --如果结束脚本就退出
            break
        end
        local n = getUnusedAllBagSlotNum()--获得背包剩余的格子数目
        if(n > 4) then --如果背包大于4格子就拾取
            ID1,ID2 = getClosetTargetIDFilterCanBeLoot() --获得最近的可以被拾取的鬼屋
            if ID1 ~= 0 and ID1 ~= -1 then --证明搜索到了怪物
                distance = getTargetAndPositionDistanceByID(ID1,ID2,x,y,3) --获得目标与玩家的距离
                if distance <= 6 and distance >= 0 then -- 如果在8码范围内，防止去拾取太远的目标，然后被卡住
                    x1,y1,z1 = getTargetPositionByID(ID1,ID2,3)
                    moveB(x1,y1,z1)
                    sleep(100)
                    contactTarget(ID1,ID2) --拾取目标
                    useLua("/click Destroyer") --销毁垃圾
                    --useLua("/click AceGUI30Button11") --销毁垃圾
                    sleep(50)
                    useLua("/click StaticPopup1Button1") --拾取蓝装
                else --范围外就跳出循环
                    break
                end
            else --代表没有可以拾取的目标了，跳出循环
                break
            end
        else
            break
        end
    end
   
    
end




--主程序开始
--从本外开始
if IsBuffExist(8326) == 0 then -- 如果身上没有带着灵魂状态的Debuff
    --进本

    moveB(1813.32,-4413.76,-18.3619)
    sleep(2000)
    moveB(1818.68,-4425.61,-20.313)
    waitForLoading()
    --进本后-- 副本内刷怪流程
    moveA(1.60201,-9.73047,-16.064)
    drink()
    sleep(1000)
    castSpellA("奥术智慧(等级 6)")
    castSpellA("冰甲术(等级 5)")
    castSpellA("寒冰护体(等级 6)")
    drink()
    useLua("/party follow1") --让小号进本
    --正式开始
    moveA(-3.71416,-41.2385,-21.8633)
    moveA(-15.2829,-50.86,-21.8637)
    castSpellB("魔爆术(等级 1)")
    moveA(-25.2615,-55.158,-21.3715)
    castSpellB("魔爆术(等级 1)")
    moveA(-38.0441,-44.6899,-21.8637)
    castSpellB("魔爆术(等级 1)")
    moveA(-45.939,-35.4412,-21.6229)
    castSpellB("魔爆术(等级 1)")
    moveA(-65.7188,-34.7073,-17.5964)
    castSpellB("魔爆术(等级 1)")
    moveA(-76.6717,-34.5333,-19.3731)
    castSpellB("闪现术")
    moveA(-110.743,-34.3445,-31.0767)
    castSpellB("魔爆术(等级 1)")
    moveA(-125.62,-34.2004,-33.0633)
    castSpellB("魔爆术(等级 1)")
    moveA(-181.09,-31.2985,-44.3847)
    castSpellB("魔爆术(等级 1)")
    moveA(-236.178,-36.139,-56.522)
    castSpellB("魔爆术(等级 1)")
    moveA(-265.367,-37.3393,-60.6928)
    castSpellB("魔爆术(等级 1)")
    moveA(-287.115,-47.6822,-60.9038)
    castSpellB("魔爆术(等级 1)")
    moveA(-289.611,-35.6505,-60.696)
    moveA(-284.66,-16.8275,-61.3293)
    castSpellB("魔爆术(等级 1)")
    moveA(-265.279,-5.76903,-63.8054)
    castSpellB("魔爆术(等级 1)")
    moveA(-236.605,-9.15504,-61.3888)
    castSpellB("魔爆术(等级 1)")
    moveA(-216.61,-7.10294,-61.8046)
    castSpellB("魔爆术(等级 1)")
    moveA(-204.31,-2.9652,-61.848)
    castSpellB("闪现术")
    moveA(-162.553,4.97743,-46.2588)
    castSpellB("魔爆术(等级 1)")
    moveA(-150.598,3.10104,-39.7492)
    castSpellB("寒冰护体(等级 6)")
    moveA(-148.099,9.809,-38.7364)
    castSpellB("魔爆术(等级 1)")
    moveA(-148.397,31.9581,-38.9008)
    castSpellB("魔爆术(等级 1)")
    moveA(-149.246,20.0884,-38.5303)
    castSpellB("魔爆术(等级 1)")
    moveA(-146.262,0.079487,-38.8552)
    castSpellB("魔爆术(等级 1)")
    moveA(-139.788,-10.2652,-53.9999)
    castSpellB("魔爆术(等级 1)")
    moveA(-162.226,-26.698,-57.8631)
    castSpellB("魔爆术(等级 1)")
    moveA(-159.552,-47.1873,-58.883)
    castSpellB("魔爆术(等级 1)")
    moveA(-144.802,-55.9364,-58.1817)
    castSpellB("魔爆术(等级 1)")
    moveA(-155.967,-66.5895,-59.5623)
    castSpellB("魔爆术(等级 1)")
    moveA(-183.002,-67.7767,-60.0676)
    castSpellB("魔爆术(等级 1)")
    moveA(-197.944,-68.7221,-63.1468)
    castSpellB("闪现术")
    moveA(-226.61,-64.565,-60.9093)
    castSpellB("魔爆术(等级 1)")
    moveA(-238.445,-58.3044,-61.8446)
    castSpellB("魔爆术(等级 1)")
    moveA(-256.617,-62.6949,-61.9795)
    castSpellB("魔爆术(等级 1)")
    moveA(-257.255,-84.7396,-60.8527)
    castSpellB("魔爆术(等级 1)")
    moveA(-274.755,-95.3236,-61.9012)
    castSpellB("魔爆术(等级 1)")
    moveA(-287.9,-83.312,-60.6141)
    castSpellB("魔爆术(等级 1)")
    moveA(-283.001,-64.9606,-60.447)
    castSpellB("魔爆术(等级 1)")
    moveA(-286.048,-54.6609,-60.7744)
    moveA(-303.078,-29.4922,-60.5633)
    castSpellB("魔爆术(等级 1)")
    moveA(-305.805,-19.2268,-57.6871)
    castSpellB("寒冰护体(等级 6)")
    moveA(-305.834,-18.8499,-57.5747)
    castSpellB("寒冰护体(等级 6)")
    moveA(-298.789,5.66857,-48.063)
    castSpellB("魔爆术(等级 1)")
    moveA(-273.347,9.89776,-50.0266)
    castSpellB("魔爆术(等级 1)")
    moveA(-258.128,9.18769,-49.8698)
    castSpellB("魔爆术(等级 1)")
    moveA(-238.48,9.02664,-44.9726)
    castSpellB("闪现术")
    moveA(-198.636,9.21406,-35.0896)
    castSpellB("魔爆术(等级 1)")
    moveA(-169.819,13.2235,-29.995)
    castSpellB("魔爆术(等级 1)")
    moveA(-113.571,11.2368,-18.5062)
    castSpellB("魔爆术(等级 1)")
    moveA(-99.4434,38.9051,-17.3889)
    castSpellB("魔爆术(等级 1)")
    moveA(-103.36,55.3073,-18.2755)
    castSpellB("魔爆术(等级 1)")
    moveA(-109.632,67.4497,-19.4641)
    castSpellB("魔爆术(等级 1)")
    moveA(-124.203,80.1813,-21.2305)
    castSpellB("魔爆术(等级 1)")
    moveA(-140.154,80.9375,-20.7765)
    castSpellB("魔爆术(等级 1)")
    moveA(-152.376,69.0107,-21.5457)
    castSpellB("魔爆术(等级 1)")
    moveA(-149.641,58.5403,-22.9354)
    castSpellB("魔爆术(等级 1)")
    moveA(-144.48,50.6882,-24.2548)
    castSpellB("魔爆术(等级 1)")
    moveA(-144.479,50.6878,-24.2547)
    castSpellB("寒冰护体(等级 6)")
    battle()
    moveA(-144.468,50.6955,-24.2525)
    sleep(2000)
    pickUp(-144.468,50.6955,-24.2525)
    moveA( -144.468,50.6955,-24.2525 )
    sleep(2000)
    drink()
    sleep(2000)
    castSpellB("寒冰护体(等级 6)")
    prints("开始休息45S")
    sleep(45000)
    --下一阶段
    moveA(-153.123,66.8443,-21.5518)
    castSpellB("魔爆术(等级 1)")
    moveA(-171.328,76.072,-21.4981)
    castSpellB("魔爆术(等级 1)")
    moveA(-199.341,87.2929,-24.7125)
    castSpellB("魔爆术(等级 1)")
    moveA(-197.006,102.952,-24.9085)
    castSpellB("魔爆术(等级 1)")
    moveA(-196.761,123.273,-22.2073)
    castSpellB("魔爆术(等级 1)")
    moveA(-190.34,154.072,-25.2199)
    castSpellB("魔爆术(等级 1)")
    moveA(-179.426,170.827,-25.089)
    castSpellB("魔爆术(等级 1)")
    moveA(-185.412,199.843,-25.1686)
    castSpellB("魔爆术(等级 1)")
    moveA(-199.943,212.374,-23.2866)
    castSpellB("魔爆术(等级 1)")
    moveA(-225.72,214.547,-24.9605)
    castSpellB("魔爆术(等级 1)")
    moveA(-234.173,198.689,-24.9156)
    castSpellB("魔爆术(等级 1)")
    moveA(-235.219,192.12,-24.5444)
    castSpellB("魔爆术(等级 1)")
    moveA(-243.191,155.991,-18.7085)
    castSpellB("魔爆术(等级 1)")
    moveA(-250.096,134.178,-18.6345)
    castSpellB("魔爆术(等级 1)")
    moveA(-254.159,124.676,-20.5875)
    castSpellB("寒冰护体(等级 6)")
    moveA(-254.365,124.213,-20.6838)
    castSpellB("寒冰护体(等级 6)")
    moveA(-254.463,123.992,-20.7298)
    castSpellB("寒冰护体(等级 6)")
    moveA(-263.742,99.9017,-25.0251)
    castSpellB("魔爆术(等级 1)")
    moveA(-256.749,92.685,-25.0187)
    castSpellB("魔爆术(等级 1)")
    moveA(-250.372,91.8286,-24.493)
    castSpellB("闪现术")
    moveA(-217.365,89.6117,-25.0184)
    castSpellB("魔爆术(等级 1)")
    moveA(-187.089,77.847,-22.7235)
    castSpellB("魔爆术(等级 1)")
    moveA(-158.764,68.5846,-21.299)
    castSpellB("魔爆术(等级 1)")
    moveA(-149.252,61.5003,-22.3396)
    castSpellB("魔爆术(等级 1)")
    moveA(-144.446,52.226,-20.6445)
    castSpellB("魔爆术(等级 1)")
    moveA(-144.469,50.6951,-24.2519)
    castSpellA("寒冰护体(等级 6)")
    moveA(-145.058,52.0699,-24.0527)
    castSpellB("魔爆术(等级 8)")
    moveA(-144.798,51.4012,-24.152)
    castSpellB("魔爆术(等级 8)")
    moveA(-144.798,51.4012,-24.152)
    castSpellB("魔爆术(等级 8)")
    moveA(-144.798,51.4012,-24.152)
    castSpellB("魔爆术(等级 8)")
    moveA(-145.213,52.3642,-24.0121)
    castSpellB("魔爆术(等级 8)")
    moveA(-145.213,52.3642,-24.0121)
    castSpellB("魔爆术(等级 8)")
    moveA(-149.178,58.5678,-22.932)
    castSpellB("魔爆术(等级 8)")
    moveA(-149.178,58.5678,-22.932)
    castSpellB("魔爆术(等级 8)")
    moveA(-149.178,58.5678,-22.932)
    battle()
    sleep(2000)
    pickUp(-149.178,58.5678,-22.932)
    moveA( -149.178,58.5678,-22.932 )
    sleep(2000)
    drink()
    sleep(2000)

    castSpellA("寒冰护体(等级 6)")
    
    sleep(90000)

    --下一阶段
    moveA( -155.996,71.4142,-21.336 )
    moveA( -192.139,88.5329,-24.2375 )
    moveA( -196.942,120.62,-22.3969 )
    moveA( -192.641,155.325,-25.2199 )
    moveA( -239.887,155.595,-18.7489 )
    moveA( -236.149,186.499,-23.0643 )
    moveA( -234.361,216.244,-24.9326 )
    moveA( -244.891,235.778,-22.5369 )
    moveA( -264.478,248.756,-18.0306 )
    moveA( -292.69,252.946,-14.9356 )
    castSpellB("魔爆术(等级 1)")
    moveA( -314.22,253.248,-11.9346 )
    castSpellB("魔爆术(等级 1)")
    moveA( -334.566,254.202,-9.58316 )
    castSpellB("魔爆术(等级 1)")
    moveA( -353.397,256.923,-6.25855 )
    castSpellB("寒冰护体(等级 6)")
    moveA( -369.396,256.68,-5.04803 )
    castSpellB("魔爆术(等级 1)")
    moveA( -383.052,254.246,-4.84771 )
    castSpellB("魔爆术(等级 1)")
    moveA( -389.448,243.582,-4.84771 )
    castSpellB("魔爆术(等级 1)")
    moveA( -399.89,219.058,-1.50532 )
    castSpellB("魔爆术(等级 1)")
    moveA( -409.661,197.44,4.03476 )
    castSpellB("魔爆术(等级 1)")
    moveA( -409.678,182.072,6.35623 )
    castSpellB("魔爆术(等级 1)")
    moveA( -389.44,151.337,7.73853 )
    castSpellB("魔爆术(等级 1)")
    moveA( -385.946,164.817,7.73851 )
    castSpellB("魔爆术(等级 1)")
    moveA( -380.301,173.617,-5.82026 )
    castSpellB("寒冰护体(等级 6)")
    moveA( -375.278,180.701,-21.8052 )
    castSpellB("魔爆术(等级 1)")
    moveA( -367.798,184.984,-22.376 )
    castSpellB("魔爆术(等级 1)")
    moveA( -369.081,203.281,-21.8833 )
    castSpellB("魔爆术(等级 1)")
    moveA( -353.596,209.762,-21.9148 )
    castSpellB("闪现术")
    moveA( -323.391,219.087,-21.0088 )
    castSpellB("魔爆术(等级 1)")
    moveA( -290.837,212.678,-25.3752 )
    castSpellB("魔爆术(等级 1)")
    moveA( -293.438,185.305,-22.9411 )
    castSpellB("魔爆术(等级 1)")
    moveA( -290.873,149.773,-25.3211 )
    castSpellB("魔爆术(等级 1)")
    moveA( -298.686,139.323,-25.0136 )
    castSpellB("寒冰护体(等级 6)")
    moveA( -300.036,138,-24.8579 )
    castSpellB("寒冰护体(等级 6)")
    moveA( -307.781,128.027,-24.7748 )
    castSpellB("魔爆术(等级 1)")
    moveA( -292.906,100.406,-26.3721 )
    castSpellB("魔爆术(等级 1)")
    moveA( -274.698,88.8479,-25.0167 )
    castSpellB("闪现术")
    moveA( -235.311,59.3349,-18.6086 )
    castSpellB("寒冰护体(等级 6)")
    moveA( -207.449,55.9048,-13.9517 )
    castSpellB("魔爆术(等级 1)")
    moveA( -158.15,56.7047,-2.66955 )
    castSpellB("魔爆术(等级 1)")
    moveA( -139.405,43.1178,0.729133 )
    castSpellB("魔爆术(等级 1)")
    moveA( -113.272,35.7233,1.11727 )
    castSpellB("魔爆术(等级 1)")
    moveA( -77.0194,56.4404,0.234257 )
    castSpellB("魔爆术(等级 1)")
    moveA( -70.2975,89.3606,-7.07167 )
    castSpellB("魔爆术(等级 1)")
    moveA( -85.4909,100.431,-7.20123 )
    castSpellB("魔爆术(等级 1)")
    moveA( -123.59,103.036,-18.9135 )
    castSpellB("魔爆术(等级 1)")
    moveA( -131.534,95.4637,-20.8924 )
    castSpellB("魔爆术(等级 1)")
    moveA( -131.841,78.3344,-21.4397 )
    castSpellB("魔爆术(等级 1)")
    moveA( -125.334,62.7865,-21.1556 )
    castSpellB("法力护盾(等级 7)")
    moveA( -116.424,43.3167,-17.6797 )
    castSpellB("寒冰护体(等级 6)")
    moveA( -122.635,35.2261,-17.5801 )
    castSpellA("寒冰屏障")
    sleep(8000)
    battle()
    sleep(2000)
    pickUp(-122.635,35.2261,-17.5801)
    moveA( -122.635,35.2261,-17.5801 )
    sleep(2000)
    drink()
    if pickUpState == 0 then
        prints("休息2分钟")
        sleep(60000)
    else
        prints("休息1分钟")
        sleep(2000)
    end
    -- 流程结束，准备出本

    moveA(-107.554,39.7473,-18.0723)
    moveA(-113.049,23.5384,-18.0833)
    moveA(-130.959,9.96667,-19.4921)
    moveA(-153.335,10.8324,-21.4403)
    moveA(-177.124,11.0496,-30.8466)
    moveA(-189.712,10.4138,-33.1046)
    moveA(-225.428,8.60991,-43.6417)
    moveA(-300.853,6.84989,-46.7702)
    sleep(60000)
    moveA(-301.565,-36.9583,-60.278)
    moveA(-294.571,-51.4712,-59.3396)
    moveA(-279.55,-49.9506,-59.2932)
    moveA(-267.939,-46.6053,-60.9321)
    moveA(-235.998,-39.4908,-56.3718)
    moveA(-183.794,-32.7887,-44.6803)
    moveA(-141.75,-32.6525,-33.1197)
    moveA(-128.896,-32.7257,-33.0713)
    moveA(-83.9896,-33.3383,-21.6926)
    moveA(-57.7421,-36.8109,-17.6673)
    moveA(-7.31883,-45.8603,-21.8637)
    moveA(-0.469735,-21.7409,-19.581)
    useLua("/party follow2")
    moveB(2.52141,-3.43138,-14.062)
    waitForLoading()
    useLua("/run ResetInstances()") --重置
  
else -- 如果身上带着灵魂状态的Debuff(人物死亡)
    moveA(1177.78,-4464.24,21.3539)
    moveA(1216.39,-4421.53,21.7456)
    moveA(1293.62,-4396.76,26.2862)
    moveA(1343.5,-4380.38,26.1741)
    moveA(1425.18,-4367.75,25.236)
    moveA(1431.77,-4378.76,25.236)
    moveA(1443.22,-4420.18,25.236)
    moveA(1468,-4418.67,25.236)
    moveA(1514.71,-4415.75,17.9052)
    moveA(1566.3,-4413.97,7.35712)
    moveA(1591.81,-4406.96,6.79834)
    moveA(1629.94,-4401.35,14.271)
    moveA(1669.11,-4396,20.7622)
    moveA(1709.38,-4376.83,27.7806)
    moveA(1735.35,-4413.64,36.7858)
    moveA(1744.34,-4430.33,37.3929)
    moveA(1727.29,-4484.78,31.5764)
    moveA(1751.37,-4511.01,27.0998)
    moveA(1780.26,-4525.68,23.7411)
    moveA(1814.44,-4527.18,20.0703)
    moveA(1846.09,-4504.94,20.9778)
    moveA(1887.99,-4470.05,19.5603)
    moveA(1894.94,-4427.22,14.0637)
    moveA(1865.68,-4415.25,7.81862)
    moveA(1836.81,-4402.85,4.18814)
    moveA(1828.99,-4399.61,1.83294)
    moveA(1807.84,-4395.82,-18.3681)
    moveA(1810.94,-4410.15,-18.5167)
    moveA(1814.52,-4417.33,-18.5257)
    moveB(1818.34,-4424.93,-20.1594)
    waitForLoading()
    moveB(2.52141,-3.43138,-14.062)
    waitForLoading()
end